version: '3'

tasks:
  default:
    desc: List available tasks
    cmds:
      - task -l

  run:
    desc: Run proxy server (uses run script)
    cmds:
      - cmd: cmd /c "{{.TASKFILE_DIR}}\\scripts\\run.bat"
        platforms: [windows]
      - cmd: bash ./scripts/run.sh
        platforms: [linux, darwin]

  run:reload:
    desc: Run proxy server with autoreload
    cmds:
      - cmd: cmd /c call "{{.TASKFILE_DIR}}\\scripts\\run.bat" --reload
        platforms: [windows]
      - cmd: bash ./scripts/run.sh --reload
        platforms: [linux, darwin]

  forwarder:
    desc: Run TCP forwarder (separate venv)
    cmds:
      - cmd: cmd /c "{{.TASKFILE_DIR}}\\scripts\\run_forwarder.bat"
        platforms: [windows]
      - cmd: bash ./scripts/run_forwarder.sh
        platforms: [linux, darwin]

  forwarder:http:
    desc: Run HTTP forwarder (reverse proxy)
    cmds:
      - cmd: cmd /c "{{.TASKFILE_DIR}}\\scripts\\run_http_forwarder.bat"
        platforms: [windows]
      - cmd: bash ./scripts/run_http_forwarder.sh
        platforms: [linux, darwin]

  ssl:generate-certs:
    desc: Generate SSL certificates using mkcert (reads hosts from config)
    cmds:
      - cmd: cmd /c "{{.TASKFILE_DIR}}\\scripts\\generate_certs.bat"
        platforms: [windows]
      - cmd: bash ./scripts/generate_certs.sh
        platforms: [linux, darwin]

  install:
    desc: Create venv + sync dependencies (uses install script)
    cmds:
      - cmd: cmd /c "{{.TASKFILE_DIR}}\\scripts\\install.bat"
        platforms: [windows]
      - cmd: bash ./scripts/install.sh
        platforms: [linux, darwin]

  install:dev:
    desc: Sync dev dependencies into the project venv
    cmds:
      - uv sync --extra dev

  test:
    desc: Run tests
    cmds:
      - uv run pytest tests -v

  simulate:
    desc: Run proxy simulation harness (see scripts/simulate_proxy.py)
    cmds:
      - uv run python scripts/simulate_proxy.py {{.CLI_ARGS}}

  clean:
    desc: Clear all logs (deletes all files in logs directory except database)
    cmds:
      - cmd: cmd /c if exist "{{.TASKFILE_DIR}}\logs\yaLLM.db" move "{{.TASKFILE_DIR}}\logs\yaLLM.db" "{{.TASKFILE_DIR}}\logs\yaLLM.db.bak"
        platforms: [windows]
      - cmd: cmd /c if exist "{{.TASKFILE_DIR}}\logs" rmdir /s /q "{{.TASKFILE_DIR}}\logs"
        platforms: [windows]
      - cmd: cmd /c if not exist "{{.TASKFILE_DIR}}\logs" mkdir "{{.TASKFILE_DIR}}\logs"
        platforms: [windows]
      - cmd: cmd /c if exist "{{.TASKFILE_DIR}}\logs\yaLLM.db.bak" move "{{.TASKFILE_DIR}}\logs\yaLLM.db.bak" "{{.TASKFILE_DIR}}\logs\yaLLM.db"
        platforms: [windows]
      - cmd: bash -c 'if [ -f "{{.TASKFILE_DIR}}/logs/yaLLM.db" ]; then mv "{{.TASKFILE_DIR}}/logs/yaLLM.db" "{{.TASKFILE_DIR}}/logs/yaLLM.db.bak"; fi && rm -rf "{{.TASKFILE_DIR}}/logs" && mkdir -p "{{.TASKFILE_DIR}}/logs" && if [ -f "{{.TASKFILE_DIR}}/logs/yaLLM.db.bak" ]; then mv "{{.TASKFILE_DIR}}/logs/yaLLM.db.bak" "{{.TASKFILE_DIR}}/logs/yaLLM.db"; fi'
        platforms: [linux, darwin]

  db-clean:
    desc: Clean request/error logs from database
    cmds:
      - uv run python scripts/db_clean.py

  db-clean-dry-run:
    desc: Preview what would be cleaned (dry run)
    cmds:
      - uv run python scripts/db_clean.py --dry-run

  db-clean-old:
    desc: Clean logs older than N days
    cmds:
      - uv run python scripts/db_clean.py --all --keep-days={{.KEEPS_DAYS | default "7"}}
